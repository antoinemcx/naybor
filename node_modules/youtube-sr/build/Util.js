"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},__values=this&&this.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var Channel_1=__importDefault(require("./Structures/Channel")),Playlist_1=__importDefault(require("./Structures/Playlist")),Video_1=__importDefault(require("./Structures/Video")),PLAYLIST_REGEX=/^https?:\/\/(www.)?youtube.com\/playlist\?list=((PL|UU|LL|RD|OL)[a-zA-Z0-9-_]{16,41})$/,PLAYLIST_ID=/(PL|UU|LL|RD|OL)[a-zA-Z0-9-_]{16,41}/,VIDEO_URL=/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/,VIDEO_ID=/^[a-zA-Z0-9-_]{11}$/,fetch=getFetch(),DEFAULT_API_KEY="AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8";function getFetch(){return"undefined"!=typeof window?window.fetch:require("node-fetch")}var Util=function(){function Util(){throw new Error("The "+this.constructor.name+" class may not be instantiated!")}return Object.defineProperty(Util,"VideoRegex",{get:function(){return VIDEO_URL},enumerable:!1,configurable:!0}),Object.defineProperty(Util,"VideoIDRegex",{get:function(){return VIDEO_ID},enumerable:!1,configurable:!0}),Object.defineProperty(Util,"PlaylistURLRegex",{get:function(){return PLAYLIST_REGEX},enumerable:!1,configurable:!0}),Object.defineProperty(Util,"PlaylistIDRegex",{get:function(){return PLAYLIST_ID},enumerable:!1,configurable:!0}),Util.getHTML=function(url,requestOptions){return requestOptions||(requestOptions={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0"}}),new Promise((function(resolve,reject){fetch(url,requestOptions).then((function(res){if(!res.ok)throw new Error("Rejected with status code: "+res.status);return res.text()})).then((function(html){return resolve(html)})).catch((function(e){return reject(e)}))}))},Util.parseDuration=function(duration){null!=duration||(duration="0:00");var args=duration.split(":"),dur=0;switch(args.length){case 3:dur=60*parseInt(args[0])*60*1e3+60*parseInt(args[1])*1e3+1e3*parseInt(args[2]);break;case 2:dur=60*parseInt(args[0])*1e3+1e3*parseInt(args[1]);break;default:dur=1e3*parseInt(args[0])}return dur},Util.parseSearchResult=function(html,options){if(!html)throw new Error("Invalid raw data");options||(options={type:"video",limit:0}),options.type||(options.type="video");var results=[],details=[],fetched=!1;try{var data=html.split("ytInitialData = JSON.parse('")[1].split("');<\/script>")[0];html=data.replace(/\\x([0-9A-F]{2})/gi,(function(){for(var items=[],_i=0;_i<arguments.length;_i++)items[_i]=arguments[_i];return String.fromCharCode(parseInt(items[1],16))}))}catch(_a){}try{details=JSON.parse(html.split('{"itemSectionRenderer":{"contents":')[html.split('{"itemSectionRenderer":{"contents":').length-1].split(',"continuations":[{')[0]),fetched=!0}catch(_b){}if(!fetched)try{details=JSON.parse(html.split('{"itemSectionRenderer":')[html.split('{"itemSectionRenderer":').length-1].split('},{"continuationItemRenderer":{')[0]).contents,fetched=!0}catch(_c){}if(!fetched)return[];for(var i=0;i<details.length&&!("number"==typeof options.limit&&options.limit>0&&results.length>=options.limit);i++){var data=details[i],res=void 0;if("all"===options.type)if(data.videoRenderer)options.type="video";else if(data.channelRenderer)options.type="channel";else{if(!data.playlistRenderer)continue;options.type="playlist"}if("video"===options.type){var parsed;if(!(parsed=Util.parseVideo(data)))continue;res=parsed}else if("channel"===options.type){var parsed;if(!(parsed=Util.parseChannel(data)))continue;res=parsed}else if("playlist"===options.type){var parsed;if(!(parsed=Util.parsePlaylist(data)))continue;res=parsed}results.push(res)}return results},Util.parseChannel=function(data){var _a,_b;if(data&&data.channelRenderer){var badge=data.channelRenderer.ownerBadges&&data.channelRenderer.ownerBadges[0],url="https://www.youtube.com"+(data.channelRenderer.navigationEndpoint.browseEndpoint.canonicalBaseUrl||data.channelRenderer.navigationEndpoint.commandMetadata.webCommandMetadata.url),res;return new Channel_1.default({id:data.channelRenderer.channelId,name:data.channelRenderer.title.simpleText,icon:data.channelRenderer.thumbnail.thumbnails[data.channelRenderer.thumbnail.thumbnails.length-1],url:url,verified:Boolean(null===(_b=null===(_a=null==badge?void 0:badge.metadataBadgeRenderer)||void 0===_a?void 0:_a.style)||void 0===_b?void 0:_b.toLowerCase().includes("verified")),subscribers:data.channelRenderer.subscriberCountText.simpleText})}},Util.parseVideo=function(data){var _a,_b,_c,_d,_e,_f,_g;if(data&&data.videoRenderer){var badge=data.videoRenderer.ownerBadges&&data.videoRenderer.ownerBadges[0],res;return new Video_1.default({id:data.videoRenderer.videoId,url:"https://www.youtube.com/watch?v="+data.videoRenderer.videoId,title:data.videoRenderer.title.runs[0].text,description:data.videoRenderer.descriptionSnippet&&data.videoRenderer.descriptionSnippet.runs[0]?data.videoRenderer.descriptionSnippet.runs[0].text:"",duration:data.videoRenderer.lengthText?Util.parseDuration(data.videoRenderer.lengthText.simpleText):0,duration_raw:data.videoRenderer.lengthText?data.videoRenderer.lengthText.simpleText:null,thumbnail:{id:data.videoRenderer.videoId,url:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].url,height:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].height,width:data.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length-1].width},channel:{id:data.videoRenderer.ownerText.runs[0].navigationEndpoint.browseEndpoint.browseId||null,name:data.videoRenderer.ownerText.runs[0].text||null,url:"https://www.youtube.com"+(data.videoRenderer.ownerText.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl||data.videoRenderer.ownerText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url),icon:{url:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].url,width:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].width,height:data.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0].height},verified:Boolean(null===(_b=null===(_a=null==badge?void 0:badge.metadataBadgeRenderer)||void 0===_a?void 0:_a.style)||void 0===_b?void 0:_b.toLowerCase().includes("verified"))},uploadedAt:null!==(_d=null===(_c=data.videoRenderer.publishedTimeText)||void 0===_c?void 0:_c.simpleText)&&void 0!==_d?_d:null,views:null!==(_g=null===(_f=null===(_e=data.videoRenderer.viewCountText)||void 0===_e?void 0:_e.simpleText)||void 0===_f?void 0:_f.replace(/[^0-9]/g,""))&&void 0!==_g?_g:0})}},Util.parsePlaylist=function(data){var res;if(data.playlistRenderer)return new Playlist_1.default({id:data.playlistRenderer.playlistId,title:data.playlistRenderer.title.simpleText,thumbnail:{id:data.playlistRenderer.playlistId,url:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].url,height:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].height,width:data.playlistRenderer.thumbnails[0].thumbnails[data.playlistRenderer.thumbnails[0].thumbnails.length-1].width},channel:{id:data.playlistRenderer.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.browseId,name:data.playlistRenderer.shortBylineText.runs[0].text,url:"https://www.youtube.com"+data.playlistRenderer.shortBylineText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url},videos:parseInt(data.playlistRenderer.videoCount.replace(/[^0-9]/g,""))},!0)},Util.getPlaylistVideos=function(data,limit){var _a,_b,_c,_d;void 0===limit&&(limit=1/0);for(var videos=[],i=0;i<data.length&&limit!==videos.length;i++){var info=data[i].playlistVideoRenderer;info&&info.shortBylineText&&videos.push(new Video_1.default({id:info.videoId,index:parseInt(null===(_a=info.index)||void 0===_a?void 0:_a.simpleText)||0,duration:Util.parseDuration(null===(_b=info.lengthText)||void 0===_b?void 0:_b.simpleText)||0,duration_raw:null!==(_d=null===(_c=info.lengthText)||void 0===_c?void 0:_c.simpleText)&&void 0!==_d?_d:"0:00",thumbnail:{id:info.videoId,url:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].url,height:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].height,width:info.thumbnail.thumbnails[info.thumbnail.thumbnails.length-1].width},title:info.title.runs[0].text,channel:{id:info.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.browseId||null,name:info.shortBylineText.runs[0].text||null,url:"https://www.youtube.com"+(info.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl||info.shortBylineText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url),icon:null}}))}return videos},Util.getPlaylist=function(html,limit){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,parsed,playlistDetails;limit&&"number"==typeof limit||(limit=100),limit<=0&&(limit=1/0);try{var rawJSON=html.split('{"playlistVideoListRenderer":{"contents":')[1].split('}],"playlistId"')[0]+"}]";parsed=JSON.parse(rawJSON),playlistDetails=JSON.parse(html.split('{"playlistSidebarRenderer":')[1].split("}};<\/script>")[0]).items}catch(_p){return null}var API_KEY=null!==(_d=null!==(_b=null===(_a=html.split('INNERTUBE_API_KEY":"')[1])||void 0===_a?void 0:_a.split('"')[0])&&void 0!==_b?_b:null===(_c=html.split('innertubeApiKey":"')[1])||void 0===_c?void 0:_c.split('"')[0])&&void 0!==_d?_d:DEFAULT_API_KEY,videos=Util.getPlaylistVideos(parsed,limit),data=playlistDetails[0].playlistSidebarPrimaryInfoRenderer;if(!data.title.runs||!data.title.runs.length)return null;var author=null===(_e=playlistDetails[1])||void 0===_e?void 0:_e.playlistSidebarSecondaryInfoRenderer.videoOwner,views=3===data.stats.length?data.stats[1].simpleText.replace(/[^0-9]/g,""):0,lastUpdate=null!==(_h=null===(_g=null===(_f=data.stats.find((function(x){return"runs"in x&&x.runs.find((function(y){return y.text.toLowerCase().includes("last update")}))})))||void 0===_f?void 0:_f.runs.pop())||void 0===_g?void 0:_g.text)&&void 0!==_h?_h:null,videosCount=data.stats[0].runs[0].text.replace(/[^0-9]/g,"")||0,res;return new Playlist_1.default({continuation:{api:API_KEY,token:Util.getContinuationToken(parsed),clientVersion:null!==(_m=null!==(_k=null===(_j=html.split('"INNERTUBE_CONTEXT_CLIENT_VERSION":"')[1])||void 0===_j?void 0:_j.split('"')[0])&&void 0!==_k?_k:null===(_l=html.split('"innertube_context_client_version":"')[1])||void 0===_l?void 0:_l.split('"')[0])&&void 0!==_m?_m:"<some version>"},id:data.title.runs[0].navigationEndpoint.watchEndpoint.playlistId,title:data.title.runs[0].text,videoCount:parseInt(videosCount)||0,lastUpdate:lastUpdate,views:parseInt(views)||0,videos:videos,url:"https://www.youtube.com/playlist?list="+data.title.runs[0].navigationEndpoint.watchEndpoint.playlistId,link:"https://www.youtube.com"+data.title.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url,author:author?{name:author.videoOwnerRenderer.title.runs[0].text,id:author.videoOwnerRenderer.title.runs[0].navigationEndpoint.browseEndpoint.browseId,url:"https://www.youtube.com"+(author.videoOwnerRenderer.navigationEndpoint.commandMetadata.webCommandMetadata.url||author.videoOwnerRenderer.navigationEndpoint.browseEndpoint.canonicalBaseUrl),icon:author.videoOwnerRenderer.thumbnail.thumbnails.length?author.videoOwnerRenderer.thumbnail.thumbnails[author.videoOwnerRenderer.thumbnail.thumbnails.length-1].url:null}:{},thumbnail:(null===(_o=data.thumbnailRenderer.playlistVideoThumbnailRenderer)||void 0===_o?void 0:_o.thumbnail.thumbnails.length)?data.thumbnailRenderer.playlistVideoThumbnailRenderer.thumbnail.thumbnails[data.thumbnailRenderer.playlistVideoThumbnailRenderer.thumbnail.thumbnails.length-1].url:null})},Util.getContinuationToken=function(ctx){var _a,_b,_c,continuationToken;return null===(_c=null===(_b=null===(_a=ctx.find((function(x){return"continuationItemRenderer"===Object.keys(x)[0]})))||void 0===_a?void 0:_a.continuationItemRenderer.continuationEndpoint)||void 0===_b?void 0:_b.continuationCommand)||void 0===_c?void 0:_c.token},Util.getVideo=function(html){var _a,_b,data,nextData={};try{var parsed=JSON.parse(html.split("var ytInitialData = ")[1].split(";<\/script>")[0]);data=parsed.contents.twoColumnWatchNextResults.results.results.contents;try{nextData=parsed.contents.twoColumnWatchNextResults.secondaryResults.secondaryResults.results}catch(_c){}}catch(_d){throw new Error("Could not parse video metadata!")}var raw={primary:data[0].videoPrimaryInfoRenderer,secondary:data[1].videoSecondaryInfoRenderer},info,payload;try{info=JSON.parse(html.split("var ytInitialPlayerResponse = ")[1].split(";<\/script>")[0]).videoDetails}catch(_e){info=JSON.parse(html.split("var ytInitialPlayerResponse = ")[1].split(";var meta")[0]).videoDetails}return info=__assign(__assign(__assign({},raw.primary),raw.secondary),{info:info}),new Video_1.default({id:info.info.videoId,title:info.info.title,views:parseInt(info.info.viewCount)||0,tags:info.info.keywords,private:info.info.isPrivate,live:info.info.isLiveContent,duration:1e3*parseInt(info.info.lengthSeconds),duration_raw:Util.durationString(Util.parseMS(1e3*parseInt(info.info.lengthSeconds)||0)),channel:{name:info.info.author,id:info.info.channelId,url:"https://www.youtube.com"+info.owner.videoOwnerRenderer.title.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl,icon:info.owner.videoOwnerRenderer.thumbnail.thumbnails[0],subscribers:null===(_b=null===(_a=info.owner.videoOwnerRenderer.subscriberCountText)||void 0===_a?void 0:_a.simpleText)||void 0===_b?void 0:_b.replace(" subscribers","")},description:info.info.shortDescription,thumbnail:__assign(__assign({},info.info.thumbnail.thumbnails[info.info.thumbnail.thumbnails.length-1]),{id:info.info.videoId}),uploadedAt:info.dateText.simpleText,ratings:{likes:parseInt(info.sentimentBar.sentimentBarRenderer.tooltip.split(" / ")[0].replace(/,/g,"")),dislikes:parseInt(info.sentimentBar.sentimentBarRenderer.tooltip.split(" / ")[1].replace(/,/g,""))},videos:Util.getNext(null!=nextData?nextData:{})})},Util.getNext=function(body,home){var e_1,_a,_b,_c,_d,_e,_f;void 0===home&&(home=!1);var results=[];if("function"!=typeof body[Symbol.iterator])return results;try{for(var body_1=__values(body),body_1_1=body_1.next();!body_1_1.done;body_1_1=body_1.next()){var result=body_1_1.value,details=home?result:result.compactVideoRenderer;if(details)try{var viewCount=details.viewCountText.simpleText;viewCount=(/^\d/.test(viewCount)?viewCount:"0").split(" ")[0],results.push(new Video_1.default({id:details.videoId,title:null!==(_b=details.title.simpleText)&&void 0!==_b?_b:null===(_c=details.title.runs[0])||void 0===_c?void 0:_c.text,views:parseInt(viewCount.replace(/,/g,""))||0,duration_raw:null!==(_d=details.lengthText.simpleText)&&void 0!==_d?_d:details.lengthText.accessibility.accessibilityData.label,duration:Util.parseDuration(details.lengthText.simpleText)/1e3,channel:{name:details.shortBylineText.runs[0].text,id:details.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.browseId,url:"https://www.youtube.com"+details.shortBylineText.runs[0].navigationEndpoint.browseEndpoint.canonicalBaseUrl,icon:home?details.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail.thumbnails[0]:details.channelThumbnail.thumbnails[0],subscribers:"0",verified:Boolean("Verified"===details.ownerBadges[0].metadataBadgeRenderer.tooltip)},thumbnail:__assign(__assign({},details.thumbnail.thumbnails[details.thumbnail.thumbnails.length-1]),{id:details.videoId}),uploadedAt:details.publishedTimeText.simpleText,ratings:{likes:0,dislikes:0},description:null===(_f=null===(_e=details.descriptionSnippet)||void 0===_e?void 0:_e.runs[0])||void 0===_f?void 0:_f.text}))}catch(_g){continue}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{body_1_1&&!body_1_1.done&&(_a=body_1.return)&&_a.call(body_1)}finally{if(e_1)throw e_1.error}}return results},Util.parseHomepage=function(html){var contents;try{contents=html.split("var ytInitialData = ")[1].split(";<\/script>")[0],contents=JSON.parse(contents).contents.twoColumnBrowseResultsRenderer.tabs[0].tabRenderer.content.richGridRenderer.contents}catch(_a){return[]}return contents&&contents.length&&contents.find((function(x){return"richItemRenderer"===Object.keys(x)[0]}))?(contents=contents.filter((function(a){return"richItemRenderer"===Object.keys(a)[0]})).map((function(m){return m.richItemRenderer.content.videoRenderer})),Util.getNext(contents,!0)):[]},Util.getPlaylistURL=function(url){if("string"!=typeof url)return null;var group=PLAYLIST_ID.exec(url),finalURL;return group?"https://www.youtube.com/playlist?list="+group[0]:null},Util.validatePlaylist=function(url){if("string"!=typeof url||null===url.match(PLAYLIST_ID))throw new Error("Invalid playlist url")},Util.filter=function(ftype){switch(ftype){case"playlist":return"EgIQAw%253D%253D";case"video":return"EgIQAQ%253D%253D";case"channel":return"EgIQAg%253D%253D";default:throw new TypeError('Invalid filter type "'+ftype+'"!')}},Util.parseMS=function(milliseconds){var roundTowardsZero=milliseconds>0?Math.floor:Math.ceil;return{days:roundTowardsZero(milliseconds/864e5),hours:roundTowardsZero(milliseconds/36e5)%24,minutes:roundTowardsZero(milliseconds/6e4)%60,seconds:roundTowardsZero(milliseconds/1e3)%60}},Util.durationString=function(data){var items=Object.keys(data),required=["days","hours","minutes","seconds"],parsed,final=items.filter((function(x){return required.includes(x)})).map((function(m){return data[m]>0?data[m]:""})).filter((function(x){return!!x})).map((function(x){return x.toString().padStart(2,"0")})).join(":");return final.length<=3?"0:"+(final.padStart(2,"0")||0):final},Util.json=function(data){try{return JSON.parse(data)}catch(_a){return null}},Util}();exports.default=Util;